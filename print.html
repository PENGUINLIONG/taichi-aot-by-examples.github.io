<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Taichi AOT by Examples</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="Learn Taichi AOT deployment with examples.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Taichi AOT by Examples</li><li class="chapter-item expanded "><a href="examples/01-version.html"><strong aria-hidden="true">1.</strong> Versioning</a></li><li class="chapter-item expanded "><a href="examples/02-arch.html"><strong aria-hidden="true">2.</strong> Taichi Arch</a></li><li class="chapter-item expanded "><a href="examples/03-runtime.html"><strong aria-hidden="true">3.</strong> Runtime Instance</a></li><li class="chapter-item expanded "><a href="examples/04-memory.html"><strong aria-hidden="true">4.</strong> Memory Allocation</a></li><li class="chapter-item expanded "><a href="examples/05-ndarray.html"><strong aria-hidden="true">5.</strong> ND-Array</a></li><li class="chapter-item expanded "><a href="examples/06-device-command.html"><strong aria-hidden="true">6.</strong> Device Command</a></li><li class="chapter-item expanded "><a href="examples/07-aot-module.html"><strong aria-hidden="true">7.</strong> AOT Module</a></li><li class="chapter-item expanded "><a href="examples/08-kernel.html"><strong aria-hidden="true">8.</strong> Kernel and Positional Argument</a></li><li class="chapter-item expanded "><a href="examples/09-error.html"><strong aria-hidden="true">9.</strong> Error Handling</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Taichi AOT by Examples</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/PENGUINLIONG/TaichiAotByExamples" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="example-1-versioning"><a class="header" href="#example-1-versioning">Example 1: Versioning</a></h1>
<p>Welcome to <em>Taichi AOT by Examples</em>. This is a step-by-step tutorial to
help you master everything about Taichi program deployment with
ahead-of-time (AOT) compilation and the Taichi Runtime C-API. Because
there are already lots of documentation about writing Taichi programs in
Python, we will focus on the integration of Taichi Runtime and
AOT-compiled kernels in your <em>native</em> applications.</p>
<p>To start with, let's make a simplest API call to ensure the Taichi Runtime
is in. We can check the currently install Taichi Runtime version with
<code>get_version</code>.</p>
<pre><code class="language-cpp">ti::Version version = ti::get_version();
</code></pre>
<p>Taichi Runtime version is synchronized with the Python package, and it's
recommended to use AOT modules and the runtime library from the same
Taichi version.</p>
<pre><code class="language-cpp">std::cout &lt;&lt; &quot;hello, this is taichi runtime &quot; &lt;&lt; version.major() &lt;&lt; &quot;.&quot;
          &lt;&lt; version.minor() &lt;&lt; &quot;.&quot; &lt;&lt; version.patch() &lt;&lt; &quot;!&quot; &lt;&lt; std::endl;
</code></pre>
<p>The above C++ code may give the following output:</p>
<pre><code class="language-plaintext">hello, this is taichi runtime 1.5.0!
</code></pre>
<blockquote>
<p>Check out this example on Github: <a href="https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/01-version">https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/01-version</a></p>
</blockquote>
<p><sub>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</sub></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="example-2-taichi-arch"><a class="header" href="#example-2-taichi-arch">Example 2: Taichi Arch</a></h1>
<p>An arch is an execution backend of Taichi Runtime. Depending on build-time
flags and current platform installation, Taichi Runtime can support one or
more archs. You can use <code>get_available_archs</code> to enumerate all the archs
available in the current environment.</p>
<pre><code class="language-cpp">std::vector&lt;TiArch&gt; archs = ti::get_available_archs();

std::cout &lt;&lt; &quot;the following archs are supported:&quot; &lt;&lt; std::endl;
for (TiArch arch : archs) {
  switch (arch) {
  case TI_ARCH_VULKAN:
    std::cout &lt;&lt; &quot;- vulkan&quot; &lt;&lt; std::endl;
    break;
  case TI_ARCH_METAL:
    std::cout &lt;&lt; &quot;- metal&quot; &lt;&lt; std::endl;
    break;
  case TI_ARCH_CUDA:
    std::cout &lt;&lt; &quot;- cuda&quot; &lt;&lt; std::endl;
    break;
  case TI_ARCH_X64:
    std::cout &lt;&lt; &quot;- x64&quot; &lt;&lt; std::endl;
    break;
  case TI_ARCH_ARM64:
    std::cout &lt;&lt; &quot;- arm64&quot; &lt;&lt; std::endl;
    break;
  case TI_ARCH_OPENGL:
    std::cout &lt;&lt; &quot;- opengl&quot; &lt;&lt; std::endl;
    break;
  case TI_ARCH_GLES:
    std::cout &lt;&lt; &quot;- gles&quot; &lt;&lt; std::endl;
    break;
  default:
    break;
  }
}
</code></pre>
<p>The above C++ code may give the following output:</p>
<pre><code class="language-plaintext">the following archs are supported:
- metal
</code></pre>
<blockquote>
<p>Check out this example on Github: <a href="https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/02-arch">https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/02-arch</a></p>
</blockquote>
<p><sub>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</sub></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="example-3-runtime-instance"><a class="header" href="#example-3-runtime-instance">Example 3: Runtime Instance</a></h1>
<p><code>ti::Runtime</code> is an instance context of the Taichi Runtime. It is
responsible of device memory allocation, memory transfer, device state
tracking and Taichi kernel launches.</p>
<p>You can create a runtime instance targeting a specific API backend like
this.</p>
<pre><code class="language-cpp">#ifdef __APPLE__
ti::Runtime runtime(TI_ARCH_METAL);
#else
ti::Runtime runtime(TI_ARCH_VULKAN);
#endif
std::cout &lt;&lt; &quot;created runtime&quot; &lt;&lt; std::endl;
</code></pre>
<p>If your working environment has multiple GPUs installed, you can choose
which one to use with its device index. By default, Taichi selects the
most powerful compute device according to an internal algorithm.</p>
<pre><code class="language-cpp">#ifdef __APPLE__
ti::Runtime runtime(TI_ARCH_METAL, 0);
#else
ti::Runtime runtime(TI_ARCH_VULKAN, 0);
#endif
std::cout &lt;&lt; &quot;created runtime with device #0&quot; &lt;&lt; std::endl;
</code></pre>
<p>The above C++ code may give the following output:</p>
<pre><code class="language-plaintext">created runtime
created runtime with device #0
</code></pre>
<blockquote>
<p>Check out this example on Github: <a href="https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/03-runtime">https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/03-runtime</a></p>
</blockquote>
<p><sub>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</sub></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="example-4-memory-allocation"><a class="header" href="#example-4-memory-allocation">Example 4: Memory Allocation</a></h1>
<p>Allocate a piece of memory on device. Device memory is usually local to
the compute device and is not accessible from the CPU.</p>
<pre><code class="language-cpp">ti::Memory device_memory = runtime.allocate_memory(4 * sizeof(uint32_t));
</code></pre>
<p>Host accessible memory can be accessed from the CPU but on-device memory
traffic during kernel launches could be much slower.</p>
<pre><code class="language-cpp">ti::Memory host_accessible_memory =
    runtime.allocate_memory(4 * sizeof(uint32_t), /*host_access=*/true);
</code></pre>
<p>You can map the device memory to get a host visible pointer to the memory
content.</p>
<pre><code class="language-cpp">void *mapped = host_accessible_memory.map();
for (uint32_t i = 0; i &lt; 4; ++i) {
  ((uint32_t*)mapped)[i] = i;
}
</code></pre>
<p>After host memory access, don't forget to unmap the memory. Some platforms
don't allow the CPU and the GPU to access the same piece of memory at the
same time and it can lead to a crash.</p>
<pre><code class="language-cpp">host_accessible_memory.unmap();
</code></pre>
<p>You can also use <code>read()</code> and <code>write()</code> for convenience.</p>
<pre><code class="language-cpp">std::vector&lt;uint32_t&gt; readback_data(4);
host_accessible_memory.read(readback_data.data(),
                            readback_data.size() * sizeof(uint32_t));

std::cout &lt;&lt; &quot;readback data has the following values:&quot;;
for (uint32_t x : readback_data) {
  std::cout &lt;&lt; &quot; &quot; &lt;&lt; x;
}
std::cout &lt;&lt; std::endl;
</code></pre>
<p>Please note that Taichi Runtime doesn't check on memory mapping. Attempts
to map non-host-accessible memory can lead to unrecoverable program
termination (usually a segfault). So please <em>do not</em> map any device only
memory. The same rule applies to <code>read()</code> and <code>write()</code> methods too.</p>
<pre><code class="language-cpp">//void *a_null_ptr = device_memory.map();
</code></pre>
<p>The above C++ code may give the following output:</p>
<pre><code class="language-plaintext">readback data has the following values: 0 1 2 3
</code></pre>
<blockquote>
<p>Check out this example on Github: <a href="https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/04-memory">https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/04-memory</a></p>
</blockquote>
<p><sub>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</sub></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="example-5-nd-array"><a class="header" href="#example-5-nd-array">Example 5: ND-Array</a></h1>
<p>Compared with <code>ti::Memory</code>, ND-array provides a more structured view over
the underlying memory.</p>
<p>ND-array is a multi dimensional dense matrix, similar to <code>ndarray</code> in
NumPy or <code>Tensor</code> in PyTorch. But they are not exactly the same. Because
in simulation and graphics we not only operate on scalars but more often
vectors and matrices, Taichi's ND-array thus have generalized the concept
of Tensor element. A Tensor can not only contain scalar elements but also
vectors and matrices, leading to its <code>elem_shape</code> attribute to represent
the dimension of the shape of each element.</p>
<p>You can allocate a host-accessible 4x4 array of 2-component vectors like
this:</p>
<pre><code class="language-cpp">ti::NdArray&lt;float&gt; arr = runtime.allocate_ndarray&lt;float&gt;({4, 4}, {2}, true);
</code></pre>
<p>You can access host-accessible ND-array data from the CPU with <code>read()</code>
and <code>write()</code>.</p>
<p>Note that ND-array has the same host-accessibility restriction as raw
memory allocations. Accessing non-host-accessible ND-arrays from the CPU
can lead to unrecoverable program termination (usually segfault).</p>
<pre><code class="language-cpp">std::vector&lt;float&gt; canvas(4 * 4 * 2);
for (size_t h = 0; h &lt; 4; ++h) {
  for (size_t w = 0; w &lt; 4; ++w) {
    canvas[(h * 4 + w) * 2 + 0] = (w + 0.5f) / 4.0f;
    canvas[(h * 4 + w) * 2 + 1] = (h + 0.5f) / 4.0f;
  }
}
arr.write(canvas);
</code></pre>
<p>To help communicating vectors and matrices between the CPU and the GPU,
you can directly <code>read()</code> and <code>write()</code> composite types (structures) from
<code>ti::NdArray</code>, as long as the composite type sizes are multiples of ND-
array scalar types.</p>
<pre><code class="language-cpp">struct Vec2 {
  float x;
  float y;
};
static_assert(sizeof(Vec2) == sizeof(uint32_t) * 2, &quot;mismatched size&quot;);

std::cout &lt;&lt; &quot;ndarray data:&quot; &lt;&lt; std::setprecision(3) &lt;&lt; std::fixed &lt;&lt; std::endl;
std::vector&lt;Vec2&gt; canvas2(4 * 4);
arr.read(canvas2);
for (size_t h = 0; h &lt; 4; ++h) {
  for (size_t w = 0; w &lt; 4; ++w) {
    const Vec2 &amp;vec = canvas2[h * 4 + w];
    std::cout &lt;&lt; &quot;(&quot; &lt;&lt; vec.x &lt;&lt; &quot;,&quot; &lt;&lt; vec.y &lt;&lt; &quot;)&quot; &lt;&lt; &quot; &quot;;
  }
  std::cout &lt;&lt; std::endl;
}
</code></pre>
<p>The above C++ code may give the following output:</p>
<pre><code class="language-plaintext">ndarray data:
(0.125,0.125) (0.375,0.125) (0.625,0.125) (0.875,0.125)
(0.125,0.375) (0.375,0.375) (0.625,0.375) (0.875,0.375)
(0.125,0.625) (0.375,0.625) (0.625,0.625) (0.875,0.625)
(0.125,0.875) (0.375,0.875) (0.625,0.875) (0.875,0.875)
</code></pre>
<blockquote>
<p>Check out this example on Github: <a href="https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/05-ndarray">https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/05-ndarray</a></p>
</blockquote>
<p><sub>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</sub></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="example-6-device-command"><a class="header" href="#example-6-device-command">Example 6: Device Command</a></h1>
<p>Taichi Runtime C-API interface functions not only have host-side
procedures like memory allocation and mapping, there are also device
commands like kernel launches and memory copy. In this example we will
demonstrate the concept of device commands and the correct usage of them,
with an example of device-to-device memory copy.</p>
<pre><code class="language-cpp">ti::NdArray&lt;float&gt; src = runtime.allocate_ndarray&lt;float&gt;({4}, {}, true);
ti::NdArray&lt;float&gt; dst = runtime.allocate_ndarray&lt;float&gt;({4}, {}, true);
src.write({1.0f, 2.0f, 3.0f, 4.0f});
</code></pre>
<p>Enqueue memory copy command to <code>runtime</code>'s default queue; copy the
underlying data of ND-array <code>src</code> to <code>dst</code>.</p>
<pre><code class="language-cpp">src.slice().copy_to(dst.slice());
</code></pre>
<p>Without synchronization we have no idea what's in <code>dst</code> right now. In this
case, <code>dst</code> is very likely to be filled with zero or random uninitialized
data.</p>
<pre><code class="language-cpp">std::vector&lt;float&gt; data(4);
dst.read(data);

std::cout &lt;&lt; &quot;floats in `dst`:&quot; &lt;&lt; std::endl;
for (float x : data) {
  std::cout &lt;&lt; x &lt;&lt; &quot; &quot;;
}
std::cout &lt;&lt; std::endl;
</code></pre>
<p>Note that the compute device might not immediately receive your device
commands so the computation could be deferred. It's recommended to call
<code>flush()</code> first to send all enqueued device commands to the device and
start execution. However, this is not necessary.</p>
<pre><code class="language-cpp">runtime.flush();
</code></pre>
<p>To guarantee all previously enqueued device commands have finished
execution. We have to wait on the runtime's default queue until it's done.</p>
<p>It might block your CPU thread for a significant length of time. Again,
it's recommended to call <code>flush()</code> first to asynchronize GPU and CPU task.
So that you can do something else on the CPU while the GPU is busy
calculating.</p>
<pre><code class="language-cpp">runtime.wait();
</code></pre>
<p>After synchronization, we can be sure that the data in <code>src</code> has been
copied to <code>dst</code>.</p>
<pre><code class="language-cpp">std::vector&lt;float&gt; data(4);
dst.read(data);

std::cout &lt;&lt; &quot;floats in `dst`:&quot; &lt;&lt; std::endl;
for (float x : data) {
  std::cout &lt;&lt; x &lt;&lt; &quot; &quot;;
}
std::cout &lt;&lt; std::endl;
</code></pre>
<p>The above C++ code may give the following output:</p>
<pre><code class="language-plaintext">floats in `dst`:
0 0 0 0
floats in `dst`:
1 2 3 4
</code></pre>
<blockquote>
<p>Check out this example on Github: <a href="https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/06-device-command">https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/06-device-command</a></p>
</blockquote>
<p><sub>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</sub></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="example-7-aot-module"><a class="header" href="#example-7-aot-module">Example 7: AOT Module</a></h1>
<p>AOT modules are containers of ahead-of-time compiled Taichi kernels. You
can compile AOT modules with <code>ti.aot.Module</code> APIs in Python.</p>
<p>After compilation, you can load AOT modules from the filesystem directly
like this:</p>
<pre><code class="language-cpp">ti::AotModule aot_module =
    runtime.load_aot_module(&quot;07-aot-module/assets/module.tcm&quot;);
std::cout &lt;&lt; &quot;loaded aot module from filesystem&quot; &lt;&lt; std::endl;
</code></pre>
<p>But if you want more control over how the module is loaded, you can
implement the loading logic yourself, and create the AOT module from data
buffer. You can also use tools like
<a href="https://manpages.ubuntu.com/manpages/bionic/man1/bin2c.1.html"><code>bin2c</code></a>
to embed module data in your source code.</p>
<pre><code class="language-cpp">std::ifstream f(&quot;07-aot-module/assets/module.tcm&quot;,
                std::ios::binary | std::ios::in | std::ios::ate);
std::vector&lt;uint8_t&gt; tcm_data(f.tellg());
f.seekg(std::ios::beg);
f.read((char*)tcm_data.data(), tcm_data.size());

ti::AotModule aot_module = runtime.create_aot_module(tcm_data);
std::cout &lt;&lt; &quot;created aot module from buffer data&quot; &lt;&lt; std::endl;
</code></pre>
<p>If you build a Taichi AOT module with the following Python script:</p>
<pre><code class="language-python">module = ti.aot.Module()
module.archive(module_path)
</code></pre>
<p>The above C++ code may give the following output:</p>
<pre><code class="language-plaintext">loaded aot module from filesystem
created aot module from buffer data
</code></pre>
<blockquote>
<p>Check out this example on Github: <a href="https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/07-aot-module">https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/07-aot-module</a></p>
</blockquote>
<p><sub>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</sub></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="example-8-kernel-and-positional-argument"><a class="header" href="#example-8-kernel-and-positional-argument">Example 8: Kernel and Positional Argument</a></h1>
<p>Taichi AOT modules may contain precompiled Taichi kernels. You can extract
the kernels by their names.</p>
<p>For example, we have a kernel called <code>chessboard</code> that prints a chessboard
pattern of interleaving zeros and ones to an ND-array.</p>
<pre><code class="language-cpp">ti::AotModule aot_module =
    runtime.load_aot_module(&quot;08-kernel/assets/module.tcm&quot;);
ti::Kernel k_chessboard = aot_module.get_kernel(&quot;chessboard&quot;);
</code></pre>
<p>To launch the kernel, we first need to assign the positional arguments.
There are two ways to setup kernel arguments.
First, you can assign arguments by their indices. This is the best if
you have many arguments but only few of them are updated frequently.</p>
<pre><code class="language-cpp">k_chessboard[0] = arr;
</code></pre>
<p>If the argument list frequently changes, like when you are prototyping
a new algorithm. You might want to clear and sequentially set the list
of argument so you don't have to reorder the indices all the time.</p>
<pre><code class="language-cpp">k_chessboard.clear_args();
k_chessboard.push_arg(arr);
</code></pre>
<p>When all the arguments are ready, you can launch the kernel with
<code>launch()</code>. Kernel launch is a device command, so it will be pushed to the
default queue of <code>runtime</code>.</p>
<pre><code class="language-cpp">k_chessboard.launch();
</code></pre>
<p>Remind that, we don't know if a device command has finished execution
unless we explicitly <code>wait()</code> upon it.</p>
<pre><code class="language-cpp">runtime.wait();

std::vector&lt;uint32_t&gt; arr_data(16);
arr.read(arr_data);
for (size_t h = 0; h &lt; 4; ++h) {
  for (size_t w = 0; w &lt; 4; ++w) {
    std::cout &lt;&lt; arr_data.at(h * 4 + w) &lt;&lt; &quot; &quot;;
  }
  std::cout &lt;&lt; std::endl;
}
</code></pre>
<p>If you build a Taichi AOT module with the following Python script:</p>
<pre><code class="language-python">@ti.kernel
def chessboard(arr: ti.types.ndarray(dtype=ti.u32, ndim=2)):
    for i, j in arr:
        arr[i, j] = (i % 2) ^ (j % 2)

arr = ti.ndarray(ti.u32, (4, 4))
chessboard(arr)
print(arr.to_numpy())

module = ti.aot.Module()
module.add_kernel(chessboard, template_args={ &quot;arr&quot;: arr })
module.archive(module_path)
</code></pre>
<p>The above C++ code may give the following output:</p>
<pre><code class="language-plaintext">0 1 0 1
1 0 1 0
0 1 0 1
1 0 1 0
</code></pre>
<blockquote>
<p>Check out this example on Github: <a href="https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/08-kernel">https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/08-kernel</a></p>
</blockquote>
<p><sub>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</sub></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="example-9-error-handling"><a class="header" href="#example-9-error-handling">Example 9: Error Handling</a></h1>
<p>When your project is complicated enough, or you are targeting multiple
platforms that might not be your development environment, errors could
occur, either by incorrect usage in your code or an implementation defact
in Taichi Runtime.</p>
<p>Taichi Runtime tries its best to ensure your incorrect usage doesn't
propagate to crash your application. You might want to regularly check if
any error occurred during your previous API calls.</p>
<pre><code class="language-cpp">ti::Error error = ti::get_last_error();
</code></pre>
<p>In most cases it reports <code>TI_ERROR_SUCCESS</code>, indicating everything is
fine.</p>
<pre><code class="language-cpp">assert(error.error == TI_ERROR_SUCCESS);
</code></pre>
<p>But if you missed something, the error code will give you a semantical
error code and a message telling you what exactly gone wrong.</p>
<pre><code class="language-cpp">ti::Runtime runtime(TI_ARCH_MAX_ENUM);
error = ti::get_last_error();
std::cout &lt;&lt; &quot;error code: &quot; &lt;&lt; error.error &lt;&lt; std::endl;
std::cout &lt;&lt; &quot;error message: &quot; &lt;&lt; error.message &lt;&lt; std::endl;
</code></pre>
<p>For any APIs that constructs or returns a new object, the returned object
won't be valid.</p>
<pre><code class="language-cpp">std::cout &lt;&lt; &quot;runtime is valid? &quot; &lt;&lt; (runtime.is_valid() ? &quot;true&quot; : &quot;false&quot;)
          &lt;&lt; std::endl;
</code></pre>
<p>The above C++ code may give the following output:</p>
<pre><code class="language-plaintext">error code: -1
error message: arch
runtime is valid? false
</code></pre>
<blockquote>
<p>Check out this example on Github: <a href="https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/09-error">https://github.com/PENGUINLIONG/TaichiAotByExamples/tree/main/09-error</a></p>
</blockquote>
<p><sub>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</sub></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
